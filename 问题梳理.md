# 问题梳理文档

## 一、项目背景

### 1.1 当前状态
- **角色**：移动端开发
- **技术栈**：腾讯 IM SDK + UISDK
- **现状**：国内版本功能完善，已上线使用

### 1.2 业务需求
- 需要将 IM 产品提供给**欧洲员工**使用
- 必须满足**GDPR 隐私政策**要求

---

## 二、核心问题

### 2.1 存储限制问题
**问题描述**：
- 腾讯 IM 服务器**只能存储消息 7 天**（隐私合规要求）
- 需要长期保存消息历史记录

**解决方案**：
- 将消息数据**转存到自己的服务器**
- 之后通过自己的服务器分发给客户端

### 2.2 数据结构不一致问题 ⚠️ **核心痛点**

**问题描述**：
- **腾讯发送给客户端**的消息结构（通过 SDK）
- **腾讯回调给服务端**的消息结构（通过 HTTP 回调）

**两者存在差异**：
- 字段不一致
- 字段数量不同
- 某些字段在回调中缺失

**影响**：
- 无法完全对齐两端数据
- 客户端依赖的某些字段在服务端回调中缺失
- 导致部分功能无法正常实现

### 2.3 架构复杂性

根据架构图（image copy.png），系统需要支持：

#### 2.3.1 双区域架构
- **欧洲区**：账号 A（欧洲）、账号 B（欧洲）
- **中国区**：账号 A（中国）、账号 B（中国）
- 账号在两地**同时创建**
- 员工账号、群组、公众号数据需要**跨国同步**

#### 2.3.2 消息查询策略（欧洲区）
```
消息查询
  ├─ 消息搜索 → 本地服务端
  └─ 消息拉取 → 拉取策略
      ├─ >7天 → 本地服务端
      └─ ≤7天 → 腾讯IM
```

#### 2.3.3 消息交互流程
- **欧洲区**：消息交互 → 账号 B（欧洲）→ 中转站（跨国）
- **中国区**：消息交互 → 账号 B（中国）← 中转站（跨国）
- **中国区**：消息查询直接走腾讯IM

#### 2.3.4 消息回调流程（image.png）
```
开发者应用
  ↓ (1) 发送群聊消息
腾讯IM后台
  ↓ (2) 群聊消息回调 (HTTP Request)
开发者后台
  ↓ (3) 本地处理 (数据同步/安全打击)
  ↓ (4) 返回回调结果 (HTTP Response)
腾讯IM后台
  ↓ (5) 下发消息 (若返回码为0)
  ↓ (6) 应答客户端
开发者应用
```

---

## 三、问题分析

### 3.1 数据流不一致的根本原因

**客户端接收的数据**（腾讯 SDK 直接下发）：
- 完整的消息对象
- 包含所有业务字段（sequence、random、cloudCustomData 等）
- 符合 UISDK 展示要求

**服务端接收的数据**（HTTP 回调）：
- 简化的回调结构
- 部分字段缺失
- 主要用于服务端处理，不包含客户端展示所需的全部信息

### 3.2 具体影响

#### 3.2.1 功能影响
- **已读回执**：可能缺少必要字段
- **消息引用（Reply）**：需要完整的 messageID，回调可能不完整
- **消息序列号（sequence）**：客户端需要但回调可能缺失
- **自定义数据（cloudCustomData）**：回调中可能不完整
- **未读数计算**：依赖腾讯服务器，服务端无法完全复现

#### 3.2.2 架构影响
- 无法完全复现腾讯的消息结构
- 客户端需要同时处理两种数据源：
  - 腾讯 SDK（7天内）
  - 自己的服务器（7天外）
- UI 层需要适配不同的数据结构

---

## 四、提出的解决方案

### 4.1 核心思路
> **针对缺少的字段，客户端对相关的功能进行屏蔽，仅对我方自己服务端能返回的字段实现功能。**

### 4.2 方案要点
1. **功能降级**：缺失字段的功能直接屏蔽
2. **数据源切换**：客户端优先使用服务端能提供的字段
3. **功能取舍**：只实现服务端能支持的功能

---

## 五、需要明确的关键问题

### 5.1 数据对齐问题
- [ ] 腾讯回调中**具体缺失哪些字段**？
- [ ] 这些字段在客户端**哪些功能中必须使用**？
- [ ] 哪些字段可以**本地生成或忽略**？

### 5.2 功能取舍问题
- [ ] 哪些功能**可以屏蔽**（不影响核心体验）？
- [ ] 哪些功能**必须保留**（IM 基础能力）？
- [ ] 哪些功能需要**自己实现**（替代方案）？

### 5.3 架构设计问题
- [ ] 如何设计**统一的消息模型**？
- [ ] 如何实现**双数据源无缝切换**？
- [ ] 如何保证**UI 层不感知数据来源差异**？

### 5.4 实施细节问题
- [ ] 消息映射层如何设计？
- [ ] 客户端如何判断使用哪个数据源？
- [ ] 历史消息如何无缝拼接？
- [ ] 跨国消息如何保证一致性？

---

## 六、下一步行动建议

### 6.1 立即需要的信息
1. **字段对比清单**：
   - 列出腾讯 SDK 消息结构的所有字段
   - 列出腾讯回调消息结构的所有字段
   - 对比差异，标注缺失字段

2. **功能依赖分析**：
   - 每个功能依赖哪些字段
   - 缺失字段对功能的影响程度

### 6.2 技术方案设计
1. **消息映射层设计**
2. **统一消息模型定义**
3. **客户端数据源切换逻辑**
4. **功能屏蔽策略**

---

## 七、总结

### 核心问题
1. ✅ **存储限制**：7天限制 → 需要自建存储（已明确）
2. ⚠️ **数据结构不一致**：SDK 数据 vs 回调数据（核心痛点）
3. ⚠️ **功能完整性**：缺失字段导致功能无法实现（需要取舍）

### 解决方案方向
- ✅ 思路可行：功能屏蔽 + 使用可用字段
- ⚠️ 需要完善：统一消息模型 + 数据源切换 + 基础能力补齐

### 关键成功因素
1. **消息对齐层**：将回调数据转换为统一格式
2. **功能分级**：明确哪些可屏蔽，哪些必须实现
3. **无缝切换**：客户端不感知数据来源差异
4. **基础能力**：补齐必要的 IM 基础功能（未读数、会话等）

